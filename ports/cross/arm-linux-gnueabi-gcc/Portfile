# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0
name                arm-linux-gnueabi-gcc
version             4.4.6
categories          cross lang
maintainers         googlemail.com:benedikt.meurer
license             {GPL-3+ Permissive}
description         The GNU Compiler Collection for arm-linux-gnueabi.
long_description    ${description}

homepage            http://gcc.gnu.org/
platforms           darwin
master_sites        gnu:gcc/gcc-${version}
distfiles           gcc-core-${version}.tar.bz2
use_bzip2           yes
universal_variant   no
checksums           gcc-core-${version}.tar.bz2 \
                        md5 c618dde07a74e0d28ba3acd487bb0f3b \
                        sha1 f305ef9c57e8016d37e7726091cb9d5c4013f9aa \
                        rmd160 9bb03852015c16a041566007b83c179178fe06f9
worksrcdir          gcc-${version}

# Parameters for this port.
set crossgcc-target arm-linux-gnueabi

depends_lib         bin:${crossgcc-target}-ar:${crossgcc-target}-binutils \
                    bin:${crossgcc-target}-as:${crossgcc-target}-binutils \
                    bin:${crossgcc-target}-ld:${crossgcc-target}-binutils \
                    bin:${crossgcc-target}-nm:${crossgcc-target}-binutils \
                    bin:${crossgcc-target}-objdump:${crossgcc-target}-binutils \
                    bin:${crossgcc-target}-ranlib:${crossgcc-target}-binutils \
                    bin:${crossgcc-target}-strip:${crossgcc-target}-binutils \
                    port:${crossgcc-target}-eglibc \
                    port:${crossgcc-target}-linux-libc-dev \
                    port:gmp \
                    port:mpfr \
                    port:libiconv

patchfiles          001-gcc-glimits-MB_LEN_MAX.patch \
                    100-alpha-mieee-default.patch \
                    110-trampolinewarn.patch \
                    130-cross-compile.patch \
                    140-default-format-security.patch \
                    150-default-fortify-source.patch \
                    160-netbsd-symbolic.patch \
                    170-sparc64-bsd.patch \
                    180-libgomp-no-werror.patch \
                    190-flatten-switch-stmt-00.patch \
                    200-libiberty.h-asprintf.patch \
                    210-arm-unbreak-armv4t.patch \
                    220-libiberty-pic.patch \
                    230-superh-default-multilib.patch \
                    250-ia64-noteGNUstack.patch \
                    260-sh-libgcc-stacks.patch \
                    270-sh-pr24836.patch \
                    280-freebsd.patch \
                    290-freebsd.patch \
                    360-arm-bigendian.patch \
                    370-bootstrap-target_lib_path.patch \
                    380-powerpc-libgcc_s-link-libm.patch \
                    390-arm-softfloat-libgcc.patch \
                    410-libgcc_eh.a.patch
patch.pre_args      -p1

# All cross ports violate the mtree layout
destroot.violate_mtree  yes

# Since we don't build gcc and binutils at the same time, gcc's Makefile will try to transform
# program names as gcc's name (add -${version} with ${version} being the version of gcc).
# But it won't work because binutils binaries don't have the ${version} suffix, and even if they
# had, they would actually have the binutils' version suffix (and not gcc's version).
# So let's tell gcc's Makefile not to do that mistake.
set environment     [list AR_FOR_TARGET=${crossgcc-target}-ar \
                     AS_FOR_TARGET=${crossgcc-target}-as \
                     LD_FOR_TARGET=${crossgcc-target}-ld \
                     NM_FOR_TARGET=${crossgcc-target}-nm \
                     OBJDUMP_FOR_TARGET=${crossgcc-target}-objdump \
                     RANLIB_FOR_TARGET=${crossgcc-target}-ranlib \
                     STRIP_FOR_TARGET=${crossgcc-target}-strip]

# Build in a different directory, as advised in the README file.
pre-configure {
    file mkdir "${workpath}/build"
}
# the generated compiler doesn't accept -arch
configure.cc_archflags
configure.cxx_archflags
configure.objc_archflags
configure.ld_archflags
configure.compiler  gcc-4.2
configure.dir       ${workpath}/build
configure.cmd       ${worksrcpath}/configure
configure.env       ${environment}
configure.args      --infodir='${prefix}/share/info' \
                    --mandir='${prefix}/share/man' \
                    --target=${crossgcc-target} \
                    --program-prefix=${crossgcc-target}- \
                    --with-headers='${prefix}/${crossgcc-target}/include' \
                    --with-libs='${prefix}/${crossgcc-target}/lib' \
                    --with-gxx-include-dir='${prefix}/${crossgcc-target}/include/c++/${version}/' \
                    --with-system-zlib \
                    --with-gmp='${prefix}' \
                    --with-mpfr='${prefix}' \
                    --with-pkgversion='MacPorts 2011/11/26' \
                    --disable-checking \
                    --disable-nls \
                    --enable-shared \
                    --enable-threads=posix \
                    --enable-symvers=gnu \
                    --enable-__cxa_atexit \
                    --disable-libmudflap \
                    --disable-libssp \
                    --disable-libstdcxx-pch \
                    --with-cpu= \
                    --enable-interwork \
                    --enable-languages='c' \
                    --enable-long-long
if {${os.platform} == "darwin" && ($build_arch == "x86_64" || $build_arch == "ppc64")} {
    configure.args-append   --build=${build_arch}-apple-darwin${os.version} \
                            --host=${build_arch}-apple-darwin${os.version}
}
build.dir           ${workpath}/build

pre-destroot {
	# gcc needs the cross directory structure to be present
	# in order to fill it during installation.
	file mkdir "${destroot}${prefix}/${crossgcc-target}/bin"
	file mkdir "${destroot}${prefix}/${crossgcc-target}/lib"
}

post-destroot {
	namespace eval crossgcc {}

	# Rename a man page if it exists.
	#
	# section: section of the man page (e.g. 1)
	# manpage: name of the man page (e.g. cpp)
	proc crossgcc::rename_man_page { section manpage } {
		global crossgcc-target destroot prefix

		set manpage_path "${destroot}${prefix}/share/man/man${section}/${manpage}.${section}"
		if { [ file exists ${manpage_path} ] } {
			file rename ${manpage_path} \
				"${destroot}${prefix}/share/man/man${section}/${crossgcc-target}-${manpage}.${section}"
		}
	}

	# Stuff I don't want (either because they're in the system
	# or because they would conflict with other FSF ports)
	# (it's easier for maintainability purposes to fix things here)

	# aliases for locales (should be on the system)
	file delete "${destroot}${prefix}/share/locale/locale.alias"
	
	# FSF propaganda (should already be there or would conflict)
	file delete -force "${destroot}${prefix}/share/info"
	file delete -force "${destroot}${prefix}/share/man/man7"

	# (host) libiberty
	foreach f [glob -directory "${destroot}${prefix}/lib" libiberty.a */libiberty.a] {
        file delete $f
    }

	# aliases for charsets (should already be there)
	file delete "${destroot}${prefix}/lib/charset.alias"
	
	# Remove man pages for tools that are not built as part of cross-gcc
	file delete "${destroot}${prefix}/share/man/man1/rmic.1"
	file delete "${destroot}${prefix}/share/man/man1/rmiregistry.1"
	file delete "${destroot}${prefix}/share/man/man1/jv-convert.1"
	file delete "${destroot}${prefix}/share/man/man1/gij.1"
	
	# For some reason, some man pages are not prefixed while they should have been
	# (to avoid conflicting).
	crossgcc::rename_man_page 1 cpp
	crossgcc::rename_man_page 1 gcjh
	crossgcc::rename_man_page 1 gcov
	crossgcc::rename_man_page 1 jcf-dump
	crossgcc::rename_man_page 1 jv-scan
	
	# There is a bug in gcc/Makefile::install-driver
	# For cross compilers, $(GCC_INSTALL_NAME) is equal to
	# $(target_noncanonical)-gcc-$(version)
	# and hence the driver isn't installed.
	xinstall -c "${workpath}/build/gcc/xgcc" \
		"${destroot}${prefix}/bin/${crossgcc-target}-gcc-${version}"
}

livecheck.type  regex
livecheck.url   http://gcc.gnu.org/gcc-4.4/
livecheck.regex GCC (4\\.4\\.\[0-9\])
